<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabinet IGC - CRM Prospects</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: #1e3a8a; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        .status { font-size: 12px; color: #93c5fd; margin-top: 5px; }
        .header-buttons { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; max-width: 400px; }
        .login-box h2 { color: #1e3a8a; margin-bottom: 10px; }
        .login-box p { color: #666; margin-bottom: 30px; }
        .section { background: white; margin-bottom: 20px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section-header { background: #2563eb; color: white; padding: 12px 20px; font-weight: bold; }
        .section-body { padding: 20px; }
        .field { margin-bottom: 15px; }
        .field label { display: block; font-weight: bold; margin-bottom: 5px; color: #374151; }
        .field input, .field select, .field textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; }
        .field textarea { resize: vertical; min-height: 80px; }
        .field.highlight input, .field.highlight textarea { background: #fef3c7; border-color: #fbbf24; }
        .save-btn { width: 100%; padding: 15px; font-size: 18px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .save-btn:hover { background: #059669; }
        .list-item { padding: 15px; border: 1px solid #e5e7eb; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .list-item:hover { background: #f3f4f6; cursor: pointer; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 40px; font-size: 18px; color: #666; }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div style="font-size: 60px; margin-bottom: 20px;">üè¢</div>
            <h2>Cabinet IGC</h2>
            <p>Conseil en Gestion de Patrimoine</p>
            <p style="font-size: 14px; color: #999;">Connectez-vous avec Google Drive pour acc√©der au CRM</p>
            <button id="loginBtn" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px;" disabled>‚è≥ Chargement des API Google...</button>
            <p id="statusMsg" style="margin-top: 10px; font-size: 12px; color: #999;"></p>
        </div>
    </div>
    <div id="app" class="hidden">
        <div class="header">
            <div><h1>üè¢ Cabinet IGC - CRM Prospects</h1><div class="status">‚úÖ Connect√© √† Google Drive</div></div>
            <div class="header-buttons">
                <button class="btn btn-danger" onclick="signOut()">D√©connexion</button>
                <button class="btn btn-primary" onclick="showList()">üìÅ Fiches (<span id="count">0</span>)</button>
            </div>
        </div>
        <div id="loading" class="loading hidden">‚è≥ Chargement des fiches...</div>
        <div id="formView" class="container">
            <div class="section"><div class="section-header"><span id="formTitle">‚ûï NOUVELLE FICHE PROSPECT</span></div><div class="section-body"><button class="save-btn" onclick="saveProspect()">üíæ ENREGISTRER SUR GOOGLE DRIVE</button></div></div>
            <div class="section"><div class="section-header">1. COORDONN√âES</div><div class="section-body">
                <div class="field"><label>N¬∞ fiche</label><input type="text" id="numeroFiche"></div>
                <div class="field"><label>Date contact</label><input type="date" id="dateContact"></div>
                <div class="field"><label>Nom</label><input type="text" id="nom"></div>
                <div class="field"><label>Pr√©nom</label><input type="text" id="prenom"></div>
                <div class="field"><label>T√©l√©phone</label><input type="tel" id="telephone"></div>
                <div class="field"><label>Email</label><input type="email" id="email"></div>
                <div class="field"><label>Origine</label><input type="text" id="origine"></div>
            </div></div>
            <div class="section"><div class="section-header">2. SITUATION FAMILIALE</div><div class="section-body">
                <div class="field"><label>Situation</label><select id="situation"><option value="">S√©lectionner...</option><option>C√©libataire</option><option>Mari√©</option><option>Pacs√©</option><option>Union libre</option></select></div>
                <div class="field"><label>√Çge prospect</label><input type="number" id="ageProspect"></div>
                <div class="field"><label>√Çge conjoint</label><input type="number" id="ageConjoint"></div>
                <div class="field"><label>Profession prospect</label><input type="text" id="professionProspect"></div>
                <div class="field"><label>Profession conjoint</label><input type="text" id="professionConjoint"></div>
                <div class="field"><label>Enfants</label><input type="text" id="enfants"></div>
            </div></div>
            <div class="section"><div class="section-header">3. SITUATION PROFESSIONNELLE</div><div class="section-body">
                <div class="field"><label>Type contrat prospect</label><select id="typeContratProspect"><option value="">S√©lectionner...</option><option>CDI</option><option>CDD</option><option>Ind√©pendant</option><option>Fonctionnaire</option></select></div>
                <div class="field"><label>Employeur prospect</label><input type="text" id="employeurProspect"></div>
                <div class="field"><label>Anciennet√©</label><input type="text" id="anciennete"></div>
                <div class="field"><label>Type contrat conjoint</label><select id="typeContratConjoint"><option value="">S√©lectionner...</option><option>CDI</option><option>CDD</option><option>Ind√©pendant</option><option>Fonctionnaire</option></select></div>
                <div class="field"><label>Employeur conjoint</label><input type="text" id="employeurConjoint"></div>
            </div></div>
            <div class="section"><div class="section-header">4. REVENUS</div><div class="section-body">
                <div class="field"><label>Revenu prospect</label><input type="number" id="revenuProspect" oninput="calculateTotal()"></div>
                <div class="field"><label>Revenu conjoint</label><input type="number" id="revenuConjoint" oninput="calculateTotal()"></div>
                <div class="field"><label>Autres revenus</label><textarea id="autresRevenus"></textarea></div>
                <div class="field highlight"><label>TOTAL REVENUS</label><input type="number" id="totalRevenus" readonly></div>
            </div></div>
            <div class="section"><div class="section-header">5. PATRIMOINE</div><div class="section-body">
                <div class="field"><label>Statut actuel</label><select id="statutActuel"><option value="">S√©lectionner...</option><option>Locataire</option><option>Propri√©taire</option><option>H√©berg√©</option></select></div>
                <div class="field"><label>Loyer/Cr√©dit mensuel</label><input type="number" id="loyerCredit"></div>
                <div class="field"><label>D√©j√† propri√©taire ?</label><select id="dejaProprietaire"><option value="">S√©lectionner...</option><option>Oui</option><option>Non</option></select></div>
                <div class="field"><label>Propri√©taire 2 derni√®res ann√©es ?</label><select id="proprietaire2ans"><option value="">S√©lectionner...</option><option>Oui</option><option>Non</option></select></div>
                <div class="field"><label>Cr√©dit en cours</label><input type="text" id="creditEnCours"></div>
                <div class="field"><label>√âpargne</label><textarea id="epargne"></textarea></div>
                <div class="field highlight"><label>APPORT</label><input type="number" id="apport"></div>
            </div></div>
            <div class="section"><div class="section-header">6. PROJET</div><div class="section-body">
                <div class="field"><label>Objectif</label><select id="objectif"><option value="">S√©lectionner...</option><option>R√©sidence Principale</option><option>Investissement</option><option>R√©sidence Secondaire</option></select></div>
                <div class="field"><label>Type bien</label><select id="typeBien"><option value="">S√©lectionner...</option><option>Appartement</option><option>Maison</option><option>Villa</option><option>Duplex</option></select></div>
                <div class="field"><label>Surface minimum (m¬≤)</label><input type="number" id="surfaceMin"></div>
                <div class="field"><label>Nombre de pi√®ces</label><input type="number" id="nombrePieces"></div>
                <div class="field highlight"><label>BUDGET MIN</label><input type="number" id="budgetMin"></div>
                <div class="field highlight"><label>BUDGET MAX</label><input type="number" id="budgetMax"></div>
                <div class="field"><label>D√©lai projet</label><input type="text" id="delai"></div>
                <div class="field"><label>VEFA ?</label><select id="vefa"><option value="">S√©lectionner...</option><option>Oui</option><option>Non</option></select></div>
            </div></div>
            <div class="section"><div class="section-header">7. LOCALISATION</div><div class="section-body">
                <div class="field"><label>Villes</label><input type="text" id="villes"></div>
                <div class="field"><label>Quartiers</label><input type="text" id="quartiers"></div>
                <div class="field"><label>Proximit√©s</label><textarea id="proximites"></textarea></div>
                <div class="field"><label>√âtage/Exposition</label><input type="text" id="etageExposition"></div>
            </div></div>
            <div class="section"><div class="section-header">8. √âQUIPEMENTS</div><div class="section-body">
                <div class="field"><label>Parking</label><input type="text" id="parking"></div>
                <div class="field"><label>Balcon/Terrasse</label><input type="text" id="balconTerrasse"></div>
                <div class="field"><label>Ascenseur/Normes</label><input type="text" id="ascenseurNormes"></div>
            </div></div>
            <div class="section"><div class="section-header">9. FINANCEMENT</div><div class="section-body">
                <div class="field"><label>Capacit√© emprunt</label><input type="number" id="capaciteEmprunt"></div>
                <div class="field"><label>Dur√©e cr√©dit</label><select id="dureeCredit"><option value="">S√©lectionner...</option><option>15 ans</option><option>20 ans</option><option>25 ans</option></select></div>
                <div class="field"><label>Mensualit√© max</label><input type="number" id="mensualiteMax"></div>
                <div class="field"><label>Capacit√© vue courtier ?</label><select id="capaciteVue"><option value="">S√©lectionner...</option><option>Oui</option><option>Non</option></select></div>
                <div class="field"><label>Nom courtier/banque</label><input type="text" id="nomCourtierBanque"></div>
                <div class="field"><label>Accord principe ?</label><select id="accordPrincipe"><option value="">S√©lectionner...</option><option>Oui</option><option>Non</option></select></div>
                <div class="field"><label>PTZ ?</label><select id="ptz"><option value="">S√©lectionner...</option><option>Oui</option><option>Non</option></select></div>
                <div class="field"><label>Autres aides</label><textarea id="autresAides"></textarea></div>
            </div></div>
            <div class="section"><div class="section-header">10. FISCALIT√â</div><div class="section-body">
                <div class="field"><label>Primo-acc√©dant ?</label><select id="primoAccedant"><option value="">S√©lectionner...</option><option>Oui</option><option>Non</option></select></div>
                <div class="field"><label>Int√©r√™t Pinel/LMNP</label><input type="text" id="interetPinel"></div>
                <div class="field"><label>TMI</label><input type="text" id="tmi"></div>
            </div></div>
            <div class="section"><div class="section-header">11. MOTIVATIONS</div><div class="section-body">
                <div class="field highlight"><label>MOTIVATION PRINCIPALE</label><textarea id="motivationPrincipale"></textarea></div>
                <div class="field"><label>Urgence (1-5)</label><input type="number" id="urgence" value="3"></div>
                <div class="field"><label>Freins</label><textarea id="freins"></textarea></div>
                <div class="field"><label>Autres programmes</label><textarea id="autresProgrammes"></textarea></div>
            </div></div>
            <div class="section"><div class="section-header">12. SUIVI</div><div class="section-body">
                <div class="field"><label>Commercial</label><input type="text" id="commercial"></div>
                <div class="field"><label>Date relance</label><input type="date" id="dateRelance"></div>
                <div class="field"><label>Biens propos√©s</label><textarea id="biensPropose"></textarea></div>
                <div class="field"><label>Visite ?</label><input type="text" id="visiteProgrammee"></div>
                <div class="field"><label>Statut</label><input type="text" id="statutDossier"></div>
            </div></div>
            <div class="section"><div class="section-header">13. NOTES</div><div class="section-body">
                <div class="field"><label>Observations</label><textarea id="notes" style="min-height: 120px;"></textarea></div>
            </div></div>
            <button class="save-btn" onclick="saveProspect()">üíæ ENREGISTRER SUR GOOGLE DRIVE</button>
        </div>
        <div id="listView" class="container hidden">
            <div class="section">
                <div class="section-header" style="display: flex; justify-content: space-between;">
                    <span>üìÅ MES FICHES (<span id="listCount">0</span>)</span>
                    <button class="btn btn-primary" onclick="showForm()">‚ûï Nouvelle</button>
                </div>
                <div class="section-body">
                    <input type="text" id="searchInput" placeholder="üîç Rechercher..." style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;" onkeyup="filterList()">
                    <div id="prospectsList"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
       const CLIENT_ID = '331078567746-bqkgd9ea5sovk58og5aij8l9jdhn28dl.apps.googleusercontent.com';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let tokenClient, accessToken, currentProspectId, allProspects = [], folderId;
        const fields = ['numeroFiche','dateContact','nom','prenom','telephone','email','origine','situation','ageProspect','ageConjoint','professionProspect','professionConjoint','enfants','typeContratProspect','employeurProspect','anciennete','typeContratConjoint','employeurConjoint','revenuProspect','revenuConjoint','autresRevenus','totalRevenus','statutActuel','loyerCredit','dejaProprietaire','proprietaire2ans','creditEnCours','epargne','apport','objectif','typeBien','surfaceMin','nombrePieces','budgetMin','budgetMax','delai','vefa','villes','quartiers','proximites','etageExposition','parking','balconTerrasse','ascenseurNormes','capaciteEmprunt','dureeCredit','mensualiteMax','capaciteVue','nomCourtierBanque','accordPrincipe','ptz','autresAides','primoAccedant','interetPinel','tmi','motivationPrincipale','urgence','freins','autresProgrammes','commercial','dateRelance','biensPropose','visiteProgrammee','statutDossier','notes'];
        function updateStatus(msg) { document.getElementById('statusMsg').textContent = msg; }
        function loadGAPI() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = () => {
                    updateStatus('‚úì API Google charg√©e');
                    gapi.load('client', () => {
                        gapi.client.init({ discoveryDocs: DISCOVERY_DOCS }).then(() => {
                            updateStatus('‚úì GAPI initialis√©');
                            resolve();
                        }).catch(reject);
                    });
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        function loadGIS() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.onload = () => {
                    updateStatus('‚úì Google Identity charg√©');
                    tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' });
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }async function initAPIs() {
            try {
                updateStatus('Chargement GAPI...');
                await loadGAPI();
                updateStatus('Chargement GIS...');
                await loadGIS();
                updateStatus('‚úì Pr√™t !');
                const btn = document.getElementById('loginBtn');
                btn.disabled = false;
                btn.textContent = 'üîê Se connecter avec Google';
                btn.onclick = handleAuthClick;
            } catch (err) {
                console.error('Erreur init:', err);
                updateStatus('‚ùå Erreur de chargement. Rafra√Æchissez la page.');
            }
        }
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) { alert('Erreur: ' + resp.error); return; }
                accessToken = gapi.client.getToken().access_token;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                await initApp();
            };
            gapi.client.getToken() === null ? tokenClient.requestAccessToken({prompt: 'consent'}) : tokenClient.requestAccessToken({prompt: ''});
        }
        function signOut() {
            const token = gapi.client.getToken();
            if (token) { google.accounts.oauth2.revoke(token.access_token); gapi.client.setToken(''); }
            location.reload();
        }
        async function initApp() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('formView').classList.add('hidden');
            try {
                await ensureFolderExists();
                await loadProspectsFromDrive();
            } catch (err) {
                console.error('Erreur:', err);
                alert('Erreur chargement.');
            }
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('formView').classList.remove('hidden');
            document.getElementById('dateContact').value = new Date().toISOString().split('T')[0];
            updateCount();
        }
        async function ensureFolderExists() {
            const response = await gapi.client.drive.files.list({ q: "name='CRM_IGC' and mimeType='application/vnd.google-apps.folder' and trashed=false", fields: 'files(id)' });
            if (response.result.files.length > 0) {
                folderId = response.result.files[0].id;
            } else {
                const folder = await gapi.client.drive.files.create({ resource: { name: 'CRM_IGC', mimeType: 'application/vnd.google-apps.folder' }, fields: 'id' });
                folderId = folder.result.id;
            }
        }
        async function loadProspectsFromDrive() {
            const response = await gapi.client.drive.files.list({ q: `'${folderId}' in parents and trashed=false`, fields: 'files(id, name)' });
            allProspects = [];
            for (const file of response.result.files) {
                try {
                    const content = await gapi.client.drive.files.get({ fileId: file.id, alt: 'media' });
                    const prospect = typeof content.result === 'string' ? JSON.parse(content.result) : content.result;
                    prospect.fileId = file.id;
                    allProspects.push(prospect);
                } catch (err) { console.error('Erreur:', err); }
            }
            updateCount();
        }
        function calculateTotal() {
            const r1 = parseFloat(document.getElementById('revenuProspect').value || 0);
            const r2 = parseFloat(document.getElementById('revenuConjoint').value || 0);
            document.getElementById('totalRevenus').value = r1 + r2;
        }
        async function saveProspect() {
            const nom = document.getElementById('nom').value;
            const prenom = document.getElementById('prenom').value;
            if (!nom || !prenom) { alert('‚ö†Ô∏è Nom et pr√©nom requis'); return; }
            const data = { id: currentProspectId || Date.now().toString() };
            fields.forEach(f => { data[f] = document.getElementById(f).value; });
            data.lastModified = new Date().toISOString();
            try {
                const filename = `IGC_${nom}_${prenom}_${data.dateContact}.json`;
                const fileContent = JSON.stringify(data, null, 2);
                let fileId = allProspects.find(p => p.id === data.id)?.fileId;
                if (fileId) {
                    await gapi.client.request({ path: `/upload/drive/v3/files/${fileId}`, method: 'PATCH', params: { uploadType: 'media' }, body: fileContent });
                } else {
                    const metadata = { name: filename, mimeType: 'application/json', parents: [folderId] };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', new Blob([fileContent], { type: 'application/json' }));
                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { Authorization: `Bearer ${accessToken}` }, body: form });
                }
                alert('‚úÖ Fiche enregistr√©e !');
                await loadProspectsFromDrive();
                clearForm();
            } catch (err) {
                console.error('Erreur:', err);
                alert('‚ùå Erreur sauvegarde');
            }
        }
        function showList() {
            document.getElementById('formView').classList.add('hidden');
            document.getElementById('listView').classList.remove('hidden');
            displayProspects();
        }
        function showForm() {
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('formView').classList.remove('hidden');
        }
        function clearForm() {
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) {
                    if (f === 'dateContact') el.value = new Date().toISOString().split('T')[0];
                    else if (f === 'urgence') el.value = '3';
                    else el.value = '';
                }
            });
            currentProspectId = null;
            document.getElementById('formTitle').textContent = '‚ûï NOUVELLE FICHE PROSPECT';
        }
        function loadProspect(id) {
            const prospect = allProspects.find(p => p.id === id);
            if (prospect) {
                fields.forEach(f => {
                    const el = document.getElementById(f);
                    if (el) el.value = prospect[f] || '';
                });
                currentProspectId = id;
                document.getElementById('formTitle').textContent = '‚úèÔ∏è MODIFICATION';
                showForm();
            }
        }
        function displayProspects() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProspects.filter(p => `${p.nom} ${p.prenom} ${p.telephone}`.toLowerCase().includes(search));
            document.getElementById('listCount').textContent = allProspects.length;
            const list = document.getElementById('prospectsList');
            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 30px;">Aucune fiche</p>';
                return;
            }
            list.innerHTML = filtered.map(p => `<div class="list-item" onclick="loadProspect('${p.id}')"><div><strong>${p.nom} ${p.prenom}</strong><br><small style="color: #666;">${p.telephone || ''} ‚Ä¢ ${p.email || ''}</small></div></div>`).join('');
        }
        function filterList() { displayProspects(); }
        function updateCount() { document.getElementById('count').textContent = allProspects.length; }
        initAPIs();
    </script>
</body>
</html>
